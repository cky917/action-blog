(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{245:function(s,a,n){"use strict";n.r(a);var e=n(4),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("最近遇到一个需求，页面嵌入了iframe框，iframe框里是一个Im在线聊天对话框。在用户切换聊天对象时，外层页面也需要获取当前用户正在聊天的对方的userid。但是由于im页面是嵌入的iframe，外层父页面既无法监听切换聊天对象的事件，也无法获取里面的dom元素，会报跨域的错误。为了解决这一问题，可以使用html5的API"),n("code",[s._v("postMessage")]),s._v(".")]),s._v(" "),n("h2",{attrs:{id:"postmessage简单介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#postmessage简单介绍"}},[s._v("#")]),s._v(" postMessage简单介绍")]),s._v(" "),n("p",[n("code",[s._v("postMessage()")]),s._v("方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文本档、多窗口、跨域消息传递。")]),s._v(" "),n("p",[n("code",[s._v("postMessage(data,origin)")]),s._v("方法接受两个参数")]),s._v(" "),n("p",[s._v("1.data:要传递的数据，html5规范中提到该参数可以是JavaScript的任意基本类型或可复制的对象，然而并不是所有浏览器都做到了这点儿，部分浏览器只能处理字符串参数，所以我们在传递参数的时候需要使用JSON.stringify()方法对对象参数序列化，在低版本IE中引用json2.js可以实现类似效果。")]),s._v(" "),n("p",[s._v('2.origin：字符串参数，指明目标窗口的源，协议+主机+端口号[+URL]，URL会被忽略，所以可以不写，这个参数是为了安全考虑，postMessage()方法只会将message传递给指定窗口，当然如果愿意也可以建参数设置为"*"，这样可以传递给任意窗口，如果要指定和当前窗口同源的话设置为"/"。')]),s._v(" "),n("h2",{attrs:{id:"子页面和父页面互相发送消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#子页面和父页面互相发送消息"}},[s._v("#")]),s._v(" 子页面和父页面互相发送消息")]),s._v(" "),n("p",[s._v("为了兼容IE和非IE的事件绑定，下面的例子直接用了jQuery监听事件，如果用原生js，注意"),n("code",[s._v("function(e)")]),s._v("中的"),n("code",[s._v("e")]),s._v("没有包装在"),n("code",[s._v("e.originalEvent")]),s._v("，需要根据实际情况获取。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//在im页面，监听切换用户事件，然后给别人发送对方的用户id。\n$('#im').on('click','.person-item',function(){\n    var data = {key:'getUserId',val:'18'};\n    window.parent.postMessage(JSON.stringify(data),'https://coolmogu.com');\n})\n//监听来自父页面的回执\n$(window).on('message',function(e){\n    var original = e.originalEvent;\n    if(original.source != window.parent) return;\n    console.log('父窗口说他收到了');\n});\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//在父页面，监听事件，\n$(window).on('message',function(e){\n    var original = e.originalEvent;\n    var data = JSON.parse(original.data);\n    if(original.origin != 'https://im.com' ||  data.key != 'getUserId'){\n        return false;\n    }\n    console.log('当前im对话的对象是' + data.val);\n    //父页面给iframe页面发送消息\n    window.frames[0].postMessage('我收到了','http://im.com');\n});\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);